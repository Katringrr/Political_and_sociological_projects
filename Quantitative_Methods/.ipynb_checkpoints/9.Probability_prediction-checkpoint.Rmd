---
title: "Home Task 5"
author: Grigorash Ekaterina
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, error = F, warning = F)
```

```{R,echo=FALSE, message=FALSE}
library(cowplot)
library(tidyverse)
library(haven)
library(car)
library(mlogit)
library(dplyr)
library(sjPlot)
```

```{r, echo=FALSE, message=FALSE}
data_set = read_dta ("NELDA.dta")
data_set = na.omit(data_set)
data_set$protestfinal = as.factor(data_set$protestfinal)
```

**1. Получите кросстабуляцию зависимой переменной (protestfinal), где 1 - наличие протеста, а 0 - его отсутствие. Что Вы можете сказать об этом распределении?** 
```{r}
table(data_set$protestfinal,useNA = "always")
```
Распределение не равномерное - 180 случаев отсутствия протестов и 55 протестов. Однако я считаю, что данное распределение можно считать нормальным для изучения - во-первых, потому что по статистике вероятность протестов меньше, чем их отсутствие (логично), во-вторых, 55 протестов достаточное количество для изучения (около 23%).

**Получите двумерную кросстабуляцию переменных protestfinal и win (победа инкумбента или его партии на выборах). Есть ли зависимость между переменными? Какие содержательные выводы мы можем сделать на основании этой таблицы?**
```{r}
xtabs(~protestfinal + win, data = data_set)
chisq.test (prof_win)
```
По горозонтали находится частотное распределение переменной **protestfinal**, по вертикальной - переменной **win**. По данной таблице мы видим, что самое большое число случаев приходится на ситуацию, когда протестов не было и инкумбент победил на выборах. Однако надо помнить, что у нас 180 случаев отсутствия протестов. Следовательно, нужно смотреть на процент, т.е. в ситуациях, когда инкумбент победил на выборах (или его партия победила), приходится 92% отсутствия протестов и 87% протестов. 
Т.е. **зависимости** между наличием или отсутствием протестов и победой инкумбента - **нет**. Для проверки можно провети тест ХИ-квадарт, чьи резуьлтаты подтверждают вывод.

**2.  Получите регрессионное уравнение зависимости вероятности протестов от таких переменных, как уровень репрессий (psyhint, где 0-нет репрессий), уровень инфляции (infl), индекс этнической фракционализации (ethfrac). Проинтерпретируйте полученные результаты. Хорошо ли модель описывает данные?**
```{r}
model = glm(protestfinal ~ psyhint + infl + ethfrac, family = "binomial", data = data_set)
tab_model(model)
```
Переменные не связаны - ни одна из них не показала значимости. Можно сделать вывод, что на вероятность протеста не влияет ни уровень репрессий, ни инфляция, ни этническая фракционализация. Модель плохо описывает наши данные.

**3.  Получите регрессионное уравнение зависимости вероятности протестов от уровня фальсификаций (NELDA Index), типы выборов (type, 1 - президентские, 0 - парламентские), бойкота оппозиции (boycottopp), а также типа авторитарного режима (gwf1). От чего зависит и НЕ зависит вероятность постэлекторального протеста?**
```{r}
data_set$type = as.factor(data_set$type)
data_set$boycottopp = as.factor(data_set$boycottopp)
data_set$gwf = as.factor(data_set$gwf)
levels(data_set$gwf)
```
```{r}
data_set[data_set$gwf == "",]$gwf = NA
data_set$gwf <- relevel(data_set$gwf, "party-based")
model2 = glm(protestfinal ~ nelda_index + type + boycottopp + gwf, family = "binomial", data = data_set)
tab_model(model2)
plot_model(model2)
```

Вероятность протестов НЕ зависит от уровня фальсификаций, типа выборов. Однако значимыми переменными оказались бойкот оппозиции и тип авторитарного управления.

В случе с бойкотом у нас коэффициент равен 0.25, следовательно, если оппозиция не бойкотирует выборы, то **шансы на протест уменьшаются** аж в 4 раза.

С авториритарным типом значимы два варианта (относительно первых двух типов) - party-personal и personal (в общем персоналистские) авторитарные режимы по сравнению с military-personal и party-based режимами **увеличивают шансы на протест** (в 11.92929 и в 3.994393, соответственно). Таким образом, вероятность наступления протеста в этих двух режимах гораздо выше, по сравнению с военно-персоналистким и партийным режимом.
```{r}
confint(regression_2) #проверить, чтобы доверительный интервал значимых переменных не заходил на 0
```

**4. Получите предсказанные вероятности для всех наблюдений.Постройте гистограмму.**
```{r,}
ggplot()+
  geom_density(aes(x = predict(model2, type = "response")))+
  theme_minimal()+
  xlab("preds")
```

**Постройте график зависимости предсказанных вероятностей в зависимости от 1) уровня фальсификаций и 2) бойкота оппозиции.**
```{r}
# от уровня фальсификации 
data_set %>% 
  filter(!is.na(gwf)) %>% 
  mutate(preds = predict(model2, type = "response")) %>% 
ggplot()+
  geom_density(aes(x = preds, col = as.factor(nelda_index)))+
  theme_minimal()+
  xlab("preds")
```

```{r}
# от байкота
data_set %>% 
  filter(!is.na(gwf)) %>% 
  mutate(preds = predict(model2, type = "response")) %>% 
ggplot(aes(x = boycottopp, y = preds))+
  geom_boxplot()+
  scale_x_discrete(labels = c("No", "Yes"))+
  theme_minimal()+
  xlab("boycott:")
```

**5. Получите предсказанные вероятности протеста 1) для каждого типа авторитаризма (gwf1), 2) для стран с высоким, средним и низким уровнем этнической фракционализации (ethfrac1), 3) для стран с высоким качеством выборов выше 50% и ниже 50%, для выборов (new_nelda), 4) где оппозиция объявила бойкот и не объявляла бойкот (boycottopp).**
```{r}
plot_model(model2, type = "eff", terms = "gwf")
get_model_data(model2, type = "eff", terms = "gwf")
```

**Дайте содержательную интерпретацию результатам.**

Извините за большую табличку, но зато все видно (я взяла только те значения, где нет NA, поэтому можно делать выводы).

Из того, что я вижу - **самая высокая вероятность наступления протеста** равна почти 50% при следующих условиях - партийно-персоналисткий военный авторитарный режим с низким уровнем этнической фракциозности, с высоким уровнем честности на выборах (прям 100% или 4 балла в индексе, если 4-это хорошо, но если 4- это плохо, то тогда наоборот) и без байкота оппозиции. 

**Самая низкая вероятность** равна примерно 3% при следующих условиях - партийная система с высоким уровнем этнической фракциозности, с достаточно плохим уровнем честности (или же обратная ситуация в зависимости от значения) и байкотированием оппозиции.

**Постройте графики предсказанных вероятностей (adjusted predictions).**
**6.  Найдите наилучшую модель из переменных type, infl, gwf, NELDA Index, boycott, ethnicfrac, psyhint.** 
```{r}
mod = glm(protestfinal ~ type + infl + gwf + nelda_index + boycottopp + ethfrac + psyhint, 
          family = "binomial",
          data = data_set)
step(mod)
```
**7. Есть ли у модели проблема мультиколлинеарности? Аутлаеров и влиятельных случаев? Есть ли, на Ваш взгляд, у модели иные проблемы?**
```{r}
vif(model_2)
#vif(model_3)
plot(model_2)
```

Есть проблема мультиколлениарнсти. Особенно - между переменными boycottopp и new_nelda. Однако если одну из этих переменных убрать из модели, то она показывает большее количество AIC.Есть выбросы, которые влияют на нашу модель - 17 и 14, напрмимер.Также есть проблемы с распределением значений, отсутствует линейность, остатки распределены неравномерно. 
В двух словах, модель не очень)))