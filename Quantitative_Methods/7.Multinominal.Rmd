---
title: "Мультиноминальная регрессия"
author: "Grigorash Ekaterina"
date: "28 11 2021"
output:
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, error = F, warning = F)
```

```{r echo=FALSE, message=FALSE}
library(haven) # чтобы использовать read_dta
library(ggplot2)
library(dplyr) # чтобы исопльзоваиь group_by
library(brant) # чтобы провести тест Бранта
library(MASS) # загружаю потому, что в ином случае лагает stargazer (не будет работать select)
library(tidyr) # для объединения на графике переменных - функиця pivot_longer
library(nnet) # чтобы сделать мультиноминальную регрессию multinom
```

## Задача 1.

Поработаем с базой данных European Social Survey (ESS) последней волны. Попробуем объяснить, что влияет на доверие парламенту (trstprl). Независимые переменные – возраст (agea), пол (gender), страна (cntry), уровень образования (eduyrs), marital status (marst).

```{r echo=FALSE, message=FALSE}
df_ess <- read_dta ("ESS_2014 .dta")
```

**А. Посмотрим на описательную статистику зависимой переменной. Количество пропущенных переменных? Частота ответов? Много ли ответов Don’t know? Что сними можно сделать?**

```{r echo=FALSE, message=FALSE, eval=FALSE}
head(df_ess$trstprl)
```

```{r}
table(df_ess$trstprl)

df_ess$trstprlF <- as.factor(df_ess$trstprl)
ggplot(df_ess, aes(trstprlF),stat="count") +
  geom_bar(fill="#93b0d0") + 
  ylab("Количество") +
  xlab("Уровень доверия") +
  theme_minimal()
```

Пропущенных значений нет, так как переменная является категориальной. Однако значения 99 (No answer), 88 (Don't know) ,77 (Refusal - это как я поняла намеренный отказ отвечать) можно принимать за пропущенные, потому что по сути это тоже самое. В таком случае у нас есть **809 пропущенных значений** - что около 2-х %.

Если посмотреть на частоту ответов (график удобнее), то можно сказать, что распредление достаточно нормальное. С таким можно работать.

Ответов "Don't know" 773, что составляет 2% от общего числа ответов. Исходя из такх цифр, можно заключить, что ответы "Don't know" и "No answer" не окажут сильного влияния на наши данные - мы можем их спокойно исключить из базы, если они нам сильно мешают, или же оставить (на усмотрение исследователя). Лично я их оставлю, если что в процессе можно их исключить.

**Б. Посмотрим на средние значения доверия по странам. В какой стране больше всего доверяют парламенту? В какой меньше?**

```{r}
df_ess$gndrF <- as.factor(df_ess$gndr)
df_ess10 <- subset(df_ess, trstprlF!="77" & trstprlF!="88" & trstprlF!="99" & gndrF!="9")
df_ess10$trstprlF <- as.numeric(df_ess10$trstprlF)

by_cntry <- df_ess10 %>% group_by (cntry)

mean <- by_cntry %>% summarise(
trstprl = mean(trstprlF))

mean[order(mean$trstprl),]
```

Итак, прежде, чем рассчитать средние значения, все же придется убрать несколько позиций, которые при подсчете приведут к искажению результата. Так, например, ответ "No answer" обаладет значением 99, а именно по значениям и будет вычислен средний уровень доверия. Поэтому мы исключаем такие пункты как 77 ("Refusal"), 88 ("Don't know") и 99 (No answer). Таким образом мы получаем равноинтервалную шкалу от 0 (полностью не доверяю) до 10 (полностью доверяю).

Больше всего доверяют в **Норвегии** (NO) - в среднем уровень доверия парламенту равен 7.7.

Меньше всего доверяют в **Словении** (SI) - в среднем уровень доверия парламенту равен 3.8.

**В. Рассчитаем модель порядковой регрессии со всеми предикторами. Насколько полученная модель хорошо описывает данные? Что означает псевдо-R2? Log-likelihood (логарифмическое правдоподобие)? Какие переменные значимо влияют на одобрение (уровень доверия)?**

```{r}
df_ess10$marsts <- as.factor(df_ess10$marsts)
df_ess10$gndr <- as.factor(df_ess10$gndr)
df_ess10$trstprlF <- as.factor(df_ess10$trstprlF)
df_ess10$marsts <- relevel(df_ess10$marsts, "6")

reg <- polr(trstprlF~agea + gndrF + cntry + eduyrs + marsts, df_ess10, Hess=TRUE)
stargazer::stargazer(reg, type="text")

```

Модель все прекрасно описывает - все переменные значимые: пол, возраст, страна, уровень образования и семейное положение. Однако их толкование немного отлично, что будет рассмотрено ниже.

```{r}
summary(reg)
exp(coef(reg))
```

**Возраст** (возраст респондента): одна единица изменения в возрасте (agea) ведет к снижению шансов (на 1%) перехода из одной категории уровня доверия в другую. Т.е. чем старше респондент, тем меньше он склонен доверять парламенту (хотя это очень незначительно, я бы сказала, что возраст не влияет).

**Пол** (2 - женщина): принадлежность к "женщинам" ведет к снижению шансов (на 15%) перехода из одной категории уровня доверия в другую.

```{r}
simbol <- c("CZ", "EE", "ES", "FR","GB", "HU","IE", "IL", "LT", "PL", "PT", "SI", "BE", "CH", "DE", "DK", "FI", "NL", "NO", "SE")
country <- c("Чехия", "Эстония", "Испания", "Франция", "Великобритания", "Венгрия", "Ирландия", "Израиль", "Литва", "Польша", "Португалия", "Словения", "Бельгия", "Швейцария", "Германия", "Дания", "Финляндия", "Нидерланды", "Норвегия", "Швеция")
persent <- c("-42%", "-16%", "-51%", "-37%", "-20%", "-40%", "-44%", "-43%", "-63%", "-70%", "-60%","-70%", "16%", "в 3 раза", "24%", "в 2,5 раза", "в 2 раза", "50%", "в 5 раз", "в 3,5 раза")

country_t <- data.frame(Символ = simbol, Страна = country, Шанс = persent)
country_t[order(country_t$Шанс),]
```

**Страна**: принадлежность к следующим странам ведет к **снижению** шансов перехода из одной категории уровня доверия в другую: Чехия (CZ на 42%), Эстония (ЕЕ на 16%), Испания (ES на 51%), Франция (FR на 37%), Великобритания (GB на 20%), Венгрия (HU на 40%), Ирландия(IE на 44%), Израиль (IL на 43%), Литва (LT на 63%), Польша (PL на 70%), Португалия (PT на 60%), Словения (SI на 70%).
Принадлежность к следующим странам ведет к **повышению** шансов перехода из одной категории уровня доверия в другую: Бельгия (BE на 16%), Швейцария (CH в более чем 3 раза), Германия (DE на 24%), Дания (DK в более чем 2,5 раза), Финляндия (FI в 2 раза), Нидерланды (NL на 50%), Норвегия(NO в 5 раз!!), Швеция (SE в 3,5 раза).

**Уровень образования** (измеряется в годах):одна единица изменения в уровне образования ведет к повышению шансов (на 2%) перехода из одной категории уровня доверия в другую. Т.е. чем больше лет человек тратит на образование, тем больше он склонен доверять правительству. Однако как и с возрастом - данная переменная не особо значимая, ибо изменение всего на 2%.

**Семейное положение**:по сравнению с незамужними и не состоящими в зарегестрированных отношениях - обладание семейного положения "юридически не вместе", "разведены","вдовец" ведет к снижению шансов (на 37%, 26%, 1% соответсвенно) перехода из одной категории уровня доверия в другую. Т.е.люди разведенные или юридически расторнгувшие отношения, но продолжающие находиться в законном браке склонны меньше доверять парламенту. Последнее наблюдение кажется особо интересным для изучения.

**Г. Проведем тест Бранта.**

```{r}
reg1 <- polr(trstprlF~agea + gndr + cntry + eduyrs + marsts, df_ess10, Hess=TRUE)
brant::brant(model = reg1) # Если probability больше 0.05, то допущение соблюдается
```

У нас есть большие проблемы с допущением, кроме двух стран - SI и EE, а также с переменной marsts. В целом мы не соблюдаем данное допущение.

**Д. Получим вероятности доверия (одобрения) в зависимости от одного из значимых предикторов для каждой категории зависимой переменной (outcome). **

```{r}
newdat_ess <- with(df_ess10, data.frame(gndr = gndr, cntry = cntry, marsts = marsts, agea = agea, eduyrs = eduyrs))
newdat_ess <- cbind(newdat_ess, predict(reg1, newdat_ess, type = "probs"))
#head(newdat_ess)
lnewdat_ess <- pivot_longer(newdat_ess, cols = c(6:16), names_to = "Trust", values_to = "Probability")
#head(lnewdat_ess)

ggplot(lnewdat_ess, aes(x = Trust, y = Probability, fill = gndr)) +
  geom_bar(stat="identity",position=position_dodge()) + scale_x_discrete(limits=c("1","2","3","4","5","6","7","8","9","10","11"),
        labels=c("Не доверяю","1","2","3","4","5","6","7","8","9","Очень доверяю"))+ scale_fill_manual(
  values = c("#93b0d0", "#eacc97"),
  name = "Пол", 
  breaks = c("1", "2"),
  labels = c("Мужчины", "Женщины")
  )+
  ylab("Вероятность") +
  xlab("Уровень доверия") +
  theme_minimal()
```

## Задача 2.

Энди Филд предлагает очередную легкомысленную задачу по базе Chat-Up Lines.dta.  Зависимая переменная (Success) принимает три значения (no response, phone number, go home with recipient). Нетрудно догадаться, что речь идет о сценариях после беседы в speed dating clubs. Предикторы: насколько смешным был разговор (сообщение) (Funny), насколько сексуальным (Sex), степень, в которой отражаются общие положительные характеристики собеседника (Good_Mate) и пол собеседника (Gender).

```{r echo=FALSE, message=FALSE}
df_chat <- read_dta("ChatUpLines.dta")
```

**А. Посмотрим на описательную статистику по зависимой переменной. Можно ли ее преобразовать в дихотомическую или шкальную?**

```{r echo=FALSE, message=FALSE, eval=FALSE}
head(df_chat$Success)
```

```{r}
table(df_chat$Success)

ggplot(df_chat, aes(Success),stat="count") +
  geom_bar(fill="#93b0d0") + 
  scale_x_discrete(limits=c("1","2","3"),labels=c("Без ответа","Получил номер","Ушли вместе"))+
  ylab("Количество") +
  xlab("Успех") +
  theme_minimal()
```

Я думаю, что можно сделать дихотомическую переменную следующим образом - объединить значения 2 и 3 в категорию "успех", а 1 в "не успех". А также шкальную, где 1 будет оцениваться как самый худший вариант, 2 как средний и 3 как самый лучший. Однако в каждом из описанных случаев это долвльно-таки сложно, потому что мы пытаемся сделать объективными достаточно субъективные вещи, которые могут не быть "равноинтервальными" - например, разрыв по значимости между ответом 1 и 2 может быть куда больше, чем разрыв между 2 и 3.

**Б. Получим ОШ для мультиномиальной модели. Какое значение зависимой переменной является базовым (референтным)?**

```{r}
df_chat$Success <- as.factor(df_chat$Success)
df_chat$Gender <- as.factor(df_chat$Gender)

model_chat <- multinom(Success~Funny+Sex+Gender, df_chat)
stargazer::stargazer(model_chat,type="text")
exp(coef(model_chat))
```

Опорной является значения 1 (No answer/Walk off). Согласно получившимся результатам - "сексуальность" разговора не влияет на исход, а вот пол собеседника и юмор имеют эффект. 

**Юмор**: одна единица изменения в переменной Funny ведет к повышению шансов на 67%, чтобы получить номер телефона, и почти в 2,5 раза, чтобы уйти вместе с партнером. Т.е. чем смешнее диалог, сообщение и т.д., тем выше шансы на самый лучший исход (по сравнению с самым худшим результатом).

**Пол**: принадлежность к женскому полу ведет к повышению шансов аж в более чем 7 раз!!!, чтобы получить номер телефона, и более чем в 25 раз!!!, чтобы уйти вместе с партнером. Т.е. при сохранении значений других переменных, если ваш партнер женщина, то у вас превосходные шансы, чтобы добиться самого лучшего расклада. 

**В. Предскажем вероятности для каждого сценария в зависимости от переменой funny.**

```{r}
newdat_chat <- with(df_chat, data.frame(Funny=Funny, Sex=Sex, Gender=Gender))
newdat_chat <- cbind(newdat_chat, predict(model_chat, newdat_chat, type = "probs"))
#head(newdat_chat)
lnewdat_chat <- pivot_longer(newdat_chat, cols = c(4:6), names_to = "Success", values_to = "Probability")
#head(lnewdat_chat)

# График
lnewdat_chat$GenderF <- factor(lnewdat_chat$Gender, levels = c("1", "2"),
                             labels = c("Партнер мужчина", "Партнер женщина"))
ggplot(lnewdat_chat, aes(x = Funny, y = Probability, fill = Success)) +
  geom_bar(stat="identity",position=position_dodge()) + facet_grid(GenderF~ .) +
  scale_fill_manual(
  values = c("#93b0d0", "#eacc97","#6f2205"),
  name = "Успех", 
  breaks = c("1", "2", "3"),
  labels = c("Без ответа", "Получил номер", "Ушли вместе")
  )+
  ylab("Вероятность") +
  xlab("Юмор") +
  theme_minimal()
```